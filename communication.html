<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Comunica√ß√£o P2P Premium - Exclusive Layer</title>
  
  <style>
    /* CSS mantido ID√äNTICO */
    :root{--gold-primary:#D4AF37;--gold-secondary:#F4E4B8;--gold-accent:#B8860B;--gold-dark:#8B6914;--platinum:#E5E4E2;--carbon:#1A1A1A;--obsidian:#0A0A0A;--emerald:#046307;--sapphire:#0F52BA;--ruby:#E0115F;--diamond:#B9F2FF;--transition:all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);--shadow-luxury:0 25px 50px rgba(0, 0, 0, 0.1),0 15px 30px rgba(0, 0, 0, 0.08);--shadow-gold:0 8px 32px rgba(212, 175, 55, 0.25);--gradient-gold:linear-gradient(135deg, #D4AF37 0%, #F4E4B8 50%, #B8860B 100%);--gradient-dark:linear-gradient(135deg, #1A1A1A 0%, #0A0A0A 100%);--gradient-card:linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(244, 228, 184, 0.05) 100%);--wet-mirror:linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 25%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.05) 75%, rgba(255, 255, 255, 0.1) 100%)}.theme-luxury{--primary-color:#D4AF37;--secondary-color:#F4E4B8;--accent-color:#B8860B;--background-primary:#0A0A0A;--background-secondary:#1A1A1A;--text-primary:#F0F0F0;--text-secondary:#B0B0B0;--container-bg:rgba(26, 26, 26, 0.95);--container-border:rgba(212, 175, 55, 0.3);--card-bg:rgba(30, 30, 30, 0.8);--card-border:rgba(212, 175, 55, 0.2);--success-color:#00C853;--warning-color:#FFD700;--error-color:#FF5252}.theme-light{--primary-color:#D4AF37;--secondary-color:#F4E4B8;--accent-color:#B8860B;--background-primary:#FFFFFF;--background-secondary:#F8F8F8;--text-primary:#1A1A1A;--text-secondary:#555555;--container-bg:rgba(255, 255, 255, 0.95);--container-border:rgba(212, 175, 55, 0.3);--card-bg:rgba(255, 255, 255, 0.9);--card-border:rgba(212, 175, 55, 0.2);--success-color:#00A859;--warning-color:#E6B400;--error-color:#E53935}*{margin:0;padding:0;box-sizing:border-box;font-family:'Inter','Helvetica Neue',Arial,sans-serif}body{background:var(--background-primary);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px;color:var(--text-primary);transition:var(--transition);font-weight:300;position:relative;overflow-x:hidden}body::before{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at 20% 80%,rgb(212 175 55/.1) 0%,transparent 50%),radial-gradient(circle at 80% 20%,rgb(244 228 184/.1) 0%,transparent 50%),radial-gradient(circle at 40% 40%,rgb(184 134 11/.05) 0%,transparent 50%);z-index:-1;animation:backgroundShift 20s ease-in-out infinite alternate}@keyframes backgroundShift{0%{transform:scale(1) rotate(0deg)}100%{transform:scale(1.1) rotate(3deg)}}.communication-container{width:100%;max-width:95%;background:var(--container-bg);backdrop-filter:blur(40px);padding:40px 30px;box-shadow:var(--shadow-luxury);border:1px solid var(--container-border);position:relative;transition:var(--transition);border-radius:24px;overflow:hidden;animation:containerEntrance 1.2s cubic-bezier(.25,.46,.45,.94)}.communication-container::before{content:'';position:absolute;top:0;left:0;right:0;height:6px;background:var(--gradient-gold);z-index:2}.communication-container::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(45deg,transparent 65%,rgb(212 175 55/.03) 65%),linear-gradient(-45deg,transparent 65%,rgb(244 228 184/.03) 65%);pointer-events:none;z-index:1}@keyframes containerEntrance{0%{opacity:0;transform:translateY(60px) scale(.95)}100%{opacity:1;transform:translateY(0) scale(1)}}header{display:flex;flex-direction:row;justify-content:space-between;align-items:center;margin-bottom:40px;padding-bottom:20px;border-bottom:1px solid rgb(212 175 55/.3);animation:fadeInDown 1s 0.3s both;position:relative;flex-wrap:wrap;gap:20px}header::after{content:'';position:absolute;bottom:-1px;left:0;width:100px;height:2px;background:var(--gradient-gold)}.logo{text-align:center;flex:1;min-width:300px}.logo h1{font-family:'Cinzel',serif;font-size:2.2rem;font-weight:600;letter-spacing:2px;color:var(--text-primary);text-transform:uppercase;position:relative;display:inline-block;text-shadow:0 2px 10px rgb(212 175 55/.3)}.logo h1::after{content:'';position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:80px;height:3px;background:var(--gradient-gold);border-radius:2px}.logo span{display:block;font-size:.8rem;letter-spacing:6px;margin-top:10px;color:var(--text-secondary);font-weight:300}.wallet-header{text-align:center;margin-bottom:40px}.wallet-header h2{font-family:'Cinzel',serif;font-size:2rem;font-weight:600;letter-spacing:2px;color:var(--text-primary);margin-bottom:15px;position:relative;display:inline-block;text-shadow:0 2px 10px rgb(212 175 55/.3)}.wallet-header h2::after{content:'';position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:60px;height:3px;background:var(--gradient-gold);border-radius:2px}.wallet-header p{color:var(--text-secondary);font-size:1rem;max-width:600px;margin:0 auto;line-height:1.6;font-weight:300;letter-spacing:.3px}.communication-main-container{background:var(--card-bg);border:1px solid var(--card-border);border-radius:24px;padding:25px;margin-top:20px;min-height:500px;position:relative;overflow:hidden}.communication-main-container::before{content:'';position:absolute;top:0;left:0;width:6px;height:100%;background:var(--gradient-gold)}.sub-tab-navigation{display:flex;gap:4px;margin:20px 0 25px 0;background:rgb(212 175 55/.05);padding:6px 10px;border-radius:16px;border:1px solid var(--container-border);backdrop-filter:blur(10px);flex-wrap:wrap}.sub-tab-btn{background:#fff0;border:1px solid var(--container-border);color:var(--text-secondary);padding:8px 12px;cursor:pointer;font-size:.8rem;transition:var(--transition);font-weight:500;letter-spacing:.5px;border-radius:8px;display:flex;align-items:center;gap:8px;position:relative;overflow:hidden;flex:1 1 auto;min-width:100px}.sub-tab-btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgb(212 175 55/.2),transparent);transition:all 0.6s ease}.sub-tab-btn:hover::before{left:100%}.sub-tab-btn:hover{border-color:var(--primary-color);color:var(--primary-color);transform:translateY(-2px);box-shadow:var(--shadow-gold)}.sub-tab-btn.active{background:rgb(212 175 55/.1);border-color:var(--primary-color);color:var(--primary-color);box-shadow:var(--shadow-gold)}.sub-tab-content{display:block;opacity:1;transition:opacity 0.5s ease}.sub-tab-content.hidden{display:none;opacity:0}.authorization-box{background:var(--gradient-card);border:1px solid var(--card-border);border-radius:20px;padding:20px;margin-top:25px;position:relative;overflow:hidden}.authorization-box::before{content:'';position:absolute;top:0;left:0;width:6px;height:100%;background:var(--gradient-gold)}.address-registration-title{font-family:'Cinzel',serif;color:var(--primary-color);margin-bottom:15px;font-size:1.4rem;display:flex;align-items:center;gap:10px;font-weight:500}.address-instruction{color:var(--text-secondary);font-size:.95rem;line-height:1.6;margin-bottom:20px}.wallet-address-display{display:flex;align-items:center;justify-content:space-between;background:rgb(212 175 55/.08);border:1px solid rgb(212 175 55/.2);border-radius:8px;padding:12px;margin-bottom:20px;font-family:'Courier New',monospace;flex-wrap:wrap;gap:10px}.address-text{color:var(--text-primary);font-size:.9rem;word-break:break-all;flex:1}.copy-btn{background:rgb(212 175 55/.1);border:1px solid var(--primary-color);color:var(--primary-color);padding:8px 15px;border-radius:6px;cursor:pointer;font-size:.85rem;display:flex;align-items:center;gap:8px;transition:var(--transition)}.copy-btn:hover{background:rgb(212 175 55/.2);transform:translateY(-2px)}.verification-status{display:flex;align-items:center;gap:10px;margin:20px 0 25px 0}.status-indicator{width:12px;height:12px;border-radius:50%}.status-indicator.verified{background:var(--success-color);box-shadow:0 0 10px var(--success-color)}.communication-badges{display:flex;flex-wrap:wrap;gap:10px;margin:25px 0}.communication-badge{background:var(--gradient-card);border:1px solid rgb(212 175 55/.2);border-radius:8px;padding:8px 12px;font-size:.85rem;display:flex;align-items:center;gap:8px;color:var(--text-primary);transition:var(--transition);flex:1 1 auto;min-width:140px}.communication-badge.unlocked{border-color:var(--success-color);background:rgb(0 200 83/.1)}.communication-badge i{color:var(--primary-color)}.communication-badge.unlocked i{color:var(--success-color)}.input-group{margin-bottom:25px}.input-group label{display:block;font-size:.9rem;margin-bottom:10px;color:var(--text-secondary);letter-spacing:1px;font-weight:400}.input-group input,.input-group textarea,.input-group select{width:100%;padding:15px 18px;border:1px solid var(--container-border);background:var(--card-bg);font-size:1rem;color:var(--text-primary);transition:var(--transition);border-radius:12px;font-weight:300;backdrop-filter:blur(10px);resize:vertical;font-family:'Inter',sans-serif}.input-group input:focus,.input-group textarea:focus,.input-group select:focus{outline:none;border-color:var(--primary-color);background:var(--background-secondary);box-shadow:0 0 0 3px rgb(212 175 55/.2)}.info-card{background:var(--card-bg);padding:30px;border-radius:20px;border:1px solid var(--card-border);transition:var(--transition);animation:slideInUp 1s 0.5s both;position:relative;overflow:hidden;backdrop-filter:blur(20px)}.info-card::before{content:'';position:absolute;top:0;left:0;width:6px;height:100%;background:var(--gradient-gold)}.info-card::after{content:'';position:absolute;top:0;right:0;width:100px;height:100px;background:radial-gradient(circle,rgb(212 175 55/.1) 0%,transparent 70%);z-index:0}.info-card:hover{transform:translateY(-10px);box-shadow:var(--shadow-luxury);border-color:var(--primary-color)}.info-card h3{font-family:'Cinzel',serif;color:var(--primary-color);margin-bottom:20px;font-size:1.5rem;display:flex;align-items:center;gap:10px;font-weight:500;position:relative;z-index:1}.contacts-list-container{max-height:300px;overflow-y:auto;margin:20px 0;border:1px solid var(--card-border);border-radius:12px;padding:12px}.contact-item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--card-border);transition:var(--transition);flex-wrap:wrap;gap:10px}.contact-item:hover{background:var(--gradient-card)}.contact-item:last-child{border-bottom:none}.contact-info{display:flex;align-items:center;gap:12px;flex:1;min-width:200px}.contact-actions{display:flex;gap:8px;flex-wrap:wrap}.add-contact-form{margin-top:25px;padding:18px;border:1px solid var(--card-border);border-radius:12px;background:var(--card-bg)}.btn{width:100%;padding:18px;border:none;cursor:pointer;font-size:.95rem;font-weight:500;letter-spacing:1px;text-transform:uppercase;transition:var(--transition);margin-bottom:12px;border-radius:12px;position:relative;overflow:hidden}.btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgb(255 255 255/.4),transparent);transition:all 0.8s ease}.btn:hover::before{left:100%}.btn::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:var(--wet-mirror);opacity:0;transition:opacity 0.5s ease;border-radius:12px;z-index:0}.btn:hover::after{opacity:1}.btn-primary{background:var(--gradient-gold);color:#1A1A1A;box-shadow:var(--shadow-gold);font-weight:600;position:relative;z-index:1}.btn-primary:hover{box-shadow:0 15px 40px rgb(212 175 55/.5);transform:translateY(-5px)}.btn-secondary{background:#fff0;color:var(--text-secondary);border:1px solid var(--container-border);box-shadow:0 4px 15px rgb(0 0 0/.1);position:relative;z-index:1}.btn-secondary:hover{border-color:var(--primary-color);color:var(--primary-color);transform:translateY(-3px);box-shadow:var(--shadow-gold)}.btn-small{width:auto;padding:12px 20px;font-size:.85rem}.btn-success{background:linear-gradient(135deg,var(--success-color),#00E676);color:#fff;box-shadow:0 8px 25px rgb(0 200 83/.4)}.btn-success:hover{box-shadow:0 12px 30px rgb(0 200 83/.6)}.chat-container{display:flex;flex-direction:column;height:400px;border:1px solid var(--card-border);border-radius:12px;overflow:hidden}.chat-messages{flex:1;overflow-y:auto;padding:15px;background:var(--card-bg)}.chat-input-area{display:flex;gap:10px;padding:12px;border-top:1px solid var(--card-border);background:var(--background-secondary)}.chat-input{flex:1;padding:10px 12px;border:1px solid var(--card-border);border-radius:8px;background:var(--card-bg);color:var(--text-primary);font-size:.9rem}.message{margin-bottom:12px;padding:8px 12px;border-radius:12px;max-width:90%;word-wrap:break-word}.message-received{background:var(--card-bg);border:1px solid var(--card-border);align-self:flex-start}.message-sent{background:var(--gradient-gold);color:#1A1A1A;align-self:flex-end;margin-left:auto}.message-sender{font-weight:600;font-size:.8rem;margin-bottom:5px;color:var(--primary-color)}.message-time{font-size:.7rem;color:var(--text-secondary);margin-top:5px;text-align:right}.video-container{width:100%;height:250px;background:#000;border-radius:12px;overflow:hidden;position:relative;display:flex;align-items:center;justify-content:center;margin-bottom:15px}.video-placeholder{text-align:center;color:#fff}.video-placeholder i{font-size:2.5rem;margin-bottom:10px;color:var(--primary-color)}.video-controls{display:flex;gap:10px;flex-wrap:wrap}.video-call-container{position:relative}.video-call-container video{width:100%;height:100%;object-fit:cover;border-radius:12px}.local-video{position:absolute;bottom:15px;right:15px;width:100px;height:75px;border:2px solid var(--primary-color);border-radius:6px;overflow:hidden;background:#000}.local-video video{width:100%;height:100%;object-fit:cover}.group-video-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px;margin-top:15px}.group-video-item{background:#000;border-radius:6px;overflow:hidden;position:relative;aspect-ratio:16/9}.group-video-item video{width:100%;height:100%;object-fit:cover}.group-video-overlay{position:absolute;bottom:5px;left:5px;background:rgb(0 0 0/.7);color:#fff;padding:3px 6px;border-radius:4px;font-size:.7rem}.no-events-message{text-align:center;padding:40px;color:var(--text-secondary)}.no-events-message i{font-size:32px;margin-bottom:10px;opacity:.5}@media (max-width:768px){.communication-container{padding:30px 20px}.logo h1{font-size:1.8rem;letter-spacing:1px}.logo span{font-size:.7rem;letter-spacing:4px}.wallet-header h2{font-size:1.6rem}.sub-tab-btn{min-width:110px;padding:8px 12px;font-size:.8rem}.communication-badge{min-width:120px}}@media (max-width:480px){body{padding:10px}.communication-container{padding:20px 15px;border-radius:20px}.logo h1{font-size:1.5rem}.logo span{font-size:.6rem;letter-spacing:3px}.wallet-header h2{font-size:1.4rem}.wallet-header p{font-size:.9rem}.sub-tab-navigation{gap:3px;padding:5px 8px}.sub-tab-btn{min-width:90px;padding:6px 10px;font-size:.75rem}.communication-badge{min-width:120px}.chat-container{height:350px}.video-container{height:200px}.local-video{width:80px;height:60px}}@media (max-width:360px){.logo h1{font-size:1.3rem}.wallet-header h2{font-size:1.2rem}.sub-tab-btn{min-width:80px;font-size:.7rem}.communication-badge{min-width:120px}}@media (orientation:landscape) and (max-height:600px){.communication-container{max-height:95vh;overflow-y:auto}.chat-container{height:300px}.video-container{height:200px}.local-video{width:80px;height:60px}}@media (min-width:769px){.communication-main-container>div{grid-template-columns:1fr 1fr;gap:30px}}
    /* Estilos adicionais para o bot√£o de retorno */
    .back-to-main-btn{background:var(--gradient-card);border:1px solid var(--container-border);color:var(--text-primary);padding:12px 20px;border-radius:10px;cursor:pointer;font-size:.9rem;display:flex;align-items:center;gap:10px;transition:var(--transition);text-decoration:none;min-width:200px}.back-to-main-btn:hover{background:rgb(212 175 55 / .1);border-color:var(--primary-color);color:var(--primary-color);transform:translateY(-2px);box-shadow:var(--shadow-gold)}.top-navigation{display:flex;justify-content:flex-end;margin-bottom:20px}.polygon-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgb(0 0 0 / .9);display:none;align-items:center;justify-content:center;z-index:10000;backdrop-filter:blur(10px)}.polygon-modal-content{background:var(--container-bg);border:2px solid var(--primary-color);border-radius:24px;padding:40px;max-width:500px;width:90%;text-align:center;box-shadow:var(--shadow-luxury);animation:containerEntrance 0.8s cubic-bezier(.25,.46,.45,.94)}.polygon-logo{font-size:48px;color:#8247E5;margin-bottom:20px}.wallet-option{background:var(--card-bg);border:1px solid var(--card-border);border-radius:12px;padding:20px;margin:15px 0;cursor:pointer;transition:var(--transition);display:flex;align-items:center;gap:15px}.wallet-option:hover{background:rgb(212 175 55 / .1);border-color:var(--primary-color);transform:translateY(-3px)}.wallet-icon{font-size:24px;color:var(--primary-color)}.wallet-info{text-align:left;flex:1}.wallet-name{font-weight:600;color:var(--text-primary);font-size:16px}.wallet-desc{color:var(--text-secondary);font-size:12px;margin-top:5px}.network-info{background:rgb(130 71 229 / .1);border:1px solid rgb(130 71 229 / .3);border-radius:8px;padding:10px;margin:20px 0;display:flex;align-items:center;gap:10px;color:#8247E5;font-size:14px}
  </style>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Cinzel:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="theme-luxury">
  <!-- Modal Polygon Wallet -->
  <div class="polygon-modal" id="polygonModal">
    <div class="polygon-modal-content">
      <div class="polygon-logo">
        <i class="fas fa-layer-group"></i>
      </div>
      <h3 style="font-family: 'Cinzel', serif; color: var(--primary-color); margin-bottom: 10px;">
        Conectar Polygon Wallet
      </h3>
      <p style="color: var(--text-secondary); margin-bottom: 25px;">
        Conecte sua wallet Polygon para autorizar a comunica√ß√£o P2P
      </p>
      
      <div class="network-info">
        <i class="fas fa-network-wired"></i>
        <span>Rede: Polygon Mainnet (Recomendada)</span>
      </div>
      
      <div class="wallet-option" onclick="connectMetaMask()">
        <div class="wallet-icon">
          <i class="fab fa-ethereum"></i>
        </div>
        <div class="wallet-info">
          <div class="wallet-name">MetaMask</div>
          <div class="wallet-desc">Carteira Ethereum e Polygon mais popular</div>
        </div>
        <i class="fas fa-chevron-right" style="color: var(--text-secondary);"></i>
      </div>
      
      <div class="wallet-option" onclick="connectWalletConnect()">
        <div class="wallet-icon">
          <i class="fas fa-wallet"></i>
        </div>
        <div class="wallet-info">
          <div class="wallet-name">WalletConnect</div>
          <div class="wallet-desc">Conecte qualquer wallet m√≥vel</div>
        </div>
        <i class="fas fa-chevron-right" style="color: var(--text-secondary);"></i>
      </div>
      
      <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--card-border);">
        <p style="color: var(--text-secondary); font-size: 12px;">
          <i class="fas fa-info-circle"></i> 
          Sua wallet permanece 100% em seu controle. N√≥s apenas verificamos a propriedade.
        </p>
      </div>
      
      <button onclick="document.getElementById('polygonModal').style.display = 'none'" 
              class="btn-secondary" style="width: 100%; margin-top: 20px;">
        <i class="fas fa-times"></i> Cancelar
      </button>
    </div>
  </div>

  <div class="communication-container">
    <header>
      <div class="logo">
        <h1>Comunica√ß√£o P2P Premium</h1>
        <span>WEBRTC REAL ‚Ä¢ BLOCKCHAIN IDENTIDADE</span>
      </div>
      <div class="top-navigation">
        <a href="index.html" class="back-to-main-btn">
          <i class="fas fa-arrow-left"></i> Retornar ao Menu Principal
        </a>
      </div>
    </header>

    <div class="communication-main-container">
      <!-- SUB-ABAS INTERNAS DA COMUNICA√á√ÉO -->
      <div class="sub-tab-navigation">
        <button class="sub-tab-btn active" data-subtab="authorizationTab">
          <i class="fas fa-key"></i> Autoriza√ß√£o
        </button>
        <button class="sub-tab-btn" data-subtab="chatIndividualTab">
          <i class="fas fa-comment"></i> Chat Individual
        </button>
        <button class="sub-tab-btn" data-subtab="chatGroupTab">
          <i class="fas fa-comments"></i> Chat Grupo
        </button>
        <button class="sub-tab-btn" data-subtab="videoIndividualTab">
          <i class="fas fa-video"></i> V√≠deo Individual
        </button>
        <button class="sub-tab-btn" data-subtab="videoGroupTab">
          <i class="fas fa-users"></i> V√≠deo Grupo
        </button>
      </div>

      <!-- SUB-ABA: AUTORIZA√á√ÉO E CONTATOS EM DUAS COLUNAS -->
      <div class="sub-tab-content active" id="authorizationTab">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
          <!-- Coluna 1: Autoriza√ß√£o -->
          <div>
            <div class="authorization-box">
              <h3 class="address-registration-title">
                <i class="fas fa-user-shield"></i> Autoriza√ß√£o de Comunica√ß√£o
              </h3>
              <p class="address-instruction">
                Vincule sua wallet Polygon e gerencie permiss√µes para comunica√ß√£o P2P. 
                Todas as configura√ß√µes s√£o salvas apenas no seu dispositivo.
              </p>
              
              <div class="wallet-address-display">
                <div class="address-text" id="linkedWalletAddress">Nenhuma wallet vinculada</div>
                <button class="copy-btn" onclick="showPolygonWalletModal()">
                  <i class="fab fa-polygon"></i> Conectar Polygon Wallet
                </button>
              </div>
              
              <div class="verification-status">
                <div class="status-indicator" id="authStatus"></div>
                <span id="authStatusText">Status: N√£o autorizado</span>
              </div>
              
              <div class="communication-badges">
                <div class="communication-badge" id="chatIndividualBadge">
                  <i class="fas fa-comment"></i> Chat Individual
                </div>
                <div class="communication-badge" id="chatGroupBadge">
                  <i class="fas fa-comments"></i> Chat Grupo
                </div>
                <div class="communication-badge" id="videoIndividualBadge">
                  <i class="fas fa-video"></i> V√≠deo Individual
                </div>
                <div class="communication-badge" id="videoGroupBadge">
                  <i class="fas fa-users"></i> V√≠deo Grupo
                </div>
                <div class="communication-badge" id="microphoneBadge">
                  <i class="fas fa-microphone"></i> Microfone
                </div>
                <div class="communication-badge" id="cameraBadge">
                  <i class="fas fa-camera"></i> C√¢mera
                </div>
              </div>
              
              <div class="input-group" style="margin-top:30px;">
                <label>Permiss√µes de Comunica√ß√£o</label>
                <div style="display:grid;grid-template-columns:1fr;gap:15px;margin-top:10px;">
                  <div>
                    <label style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                      <input type="checkbox" id="permissionChatIndividual" onchange="togglePermission('chatIndividual', this.checked)">
                      Chat Individual
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                      <input type="checkbox" id="permissionChatGroup" onchange="togglePermission('chatGroup', this.checked)">
                      Chat em Grupo
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                      <input type="checkbox" id="permissionVideoIndividual" onchange="togglePermission('videoIndividual', this.checked)">
                      V√≠deo Individual
                    </label>
                  </div>
                  <div>
                    <label style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                      <input type="checkbox" id="permissionVideoGroup" onchange="togglePermission('videoGroup', this.checked)">
                      V√≠deo em Grupo
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                      <input type="checkbox" id="permissionMicrophone" onchange="togglePermission('microphone', this.checked)">
                      Microfone
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                      <input type="checkbox" id="permissionCamera" onchange="togglePermission('camera', this.checked)">
                      C√¢mera
                    </label>
                  </div>
                </div>
              </div>
              
              <div style="margin-top:25px;">
                <button class="btn-primary btn-small" onclick="saveAuthorization()" style="width:100%;">
                  <i class="fas fa-save"></i> Salvar Autoriza√ß√µes
                </button>
              </div>
            </div>
          </div>
          
          <!-- Coluna 2: Contatos -->
          <div>
            <div class="info-card">
              <h3><i class="fas fa-address-book"></i> Gerenciar Contatos</h3>
              <p style="color:var(--text-secondary);margin-bottom:20px;">
                Adicione e gerencie contatos para comunica√ß√£o P2P. Os contatos s√£o salvos apenas localmente.
              </p>
              
              <div class="contacts-list-container" id="contactsListContainer">
                <!-- Contatos ser√£o listados aqui -->
              </div>
              
              <div class="add-contact-form">
                <h4 style="color:var(--primary-color);margin-bottom:15px;font-size:16px;">
                  <i class="fas fa-plus-circle"></i> Adicionar Novo Contato
                </h4>
                <div class="input-group">
                  <label><i class="fab fa-polygon"></i> Endere√ßo da Wallet Polygon</label>
                  <input type="text" id="contactWalletAddress" placeholder="0x..." style="font-family:'Courier New',monospace;">
                </div>
                <div class="input-group">
                  <label><i class="fas fa-user"></i> Nome do Contato (opcional)</label>
                  <input type="text" id="contactName" placeholder="Nome para identifica√ß√£o">
                </div>
                <button class="btn-primary btn-small" onclick="addContact()" style="width:100%;">
                  <i class="fas fa-user-plus"></i> Adicionar Contato
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- SUB-ABA: CHAT INDIVIDUAL -->
      <div class="sub-tab-content hidden" id="chatIndividualTab">
        <div class="info-card">
          <h3><i class="fas fa-comment"></i> Chat Individual P2P</h3>
          <div style="display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap;">
            <select id="chatIndividualContact" class="input-group" style="flex:1;padding:12px;border:1px solid var(--card-border);border-radius:8px;background:var(--card-bg);color:var(--text-primary);min-width:200px;">
              <option value="">Selecione um contato...</option>
            </select>
            <button class="btn-secondary btn-small" onclick="startIndividualChat()">
              <i class="fas fa-play"></i> Iniciar Chat
            </button>
          </div>
          
          <div class="chat-container" id="individualChatContainer" style="display:none;">
            <div class="chat-messages" id="individualChatMessages">
              <div class="no-events-message">
                <i class="fas fa-comments" style="font-size:32px;margin-bottom:10px;opacity:0.5;"></i>
                <p>Nenhuma mensagem ainda</p>
              </div>
            </div>
            <div class="chat-input-area">
              <input type="text" class="chat-input" id="individualChatInput" placeholder="Digite sua mensagem..." disabled>
              <button class="btn-primary btn-small" id="individualChatSendBtn" onclick="sendIndividualChatMessage()" disabled>
                <i class="fas fa-paper-plane"></i> Enviar
              </button>
            </div>
          </div>
          
          <div id="individualChatNotStarted" style="text-align:center;padding:40px;">
            <i class="fas fa-comment-slash" style="font-size:48px;color:var(--text-secondary);opacity:0.3;margin-bottom:20px;"></i>
            <p style="color:var(--text-secondary);">
              Selecione um contato e inicie o chat para come√ßar a conversar
            </p>
          </div>
        </div>
      </div>

      <!-- SUB-ABA: CHAT GRUPO -->
      <div class="sub-tab-content hidden" id="chatGroupTab">
        <div class="info-card">
          <h3><i class="fas fa-comments"></i> Chat em Grupo P2P</h3>
          <div style="margin-bottom:20px;">
            <label style="display:block;margin-bottom:10px;color:var(--text-secondary);">
              <i class="fas fa-users"></i> Selecione contatos para o grupo:
            </label>
            <div id="groupChatContactsList" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));gap:10px;">
              <!-- Contatos para sele√ß√£o ser√£o inseridos aqui -->
            </div>
          </div>
          
          <div style="display:flex;gap:10px;margin-top:20px;flex-wrap:wrap;">
            <input type="text" id="groupChatName" placeholder="Nome do grupo" style="flex:1;padding:12px;border:1px solid var(--card-border);border-radius:8px;background:var(--card-bg);color:var(--text-primary);min-width:200px;">
            <button class="btn-secondary btn-small" onclick="createGroupChat()">
              <i class="fas fa-plus"></i> Criar Grupo
            </button>
          </div>
          
          <div class="chat-container" id="groupChatContainer" style="display:none;margin-top:20px;">
            <div class="chat-messages" id="groupChatMessages">
              <div class="no-events-message">
                <i class="fas fa-comments" style="font-size:32px;margin-bottom:10px;opacity:0.5;"></i>
                <p>Nenhuma mensagem ainda no grupo</p>
              </div>
            </div>
            <div class="chat-input-area">
              <input type="text" class="chat-input" id="groupChatInput" placeholder="Digite sua mensagem para o grupo..." disabled>
              <button class="btn-primary btn-small" id="groupChatSendBtn" onclick="sendGroupChatMessage()" disabled>
                <i class="fas fa-paper-plane"></i> Enviar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- SUB-ABA: V√çDEO INDIVIDUAL -->
      <div class="sub-tab-content hidden" id="videoIndividualTab">
        <div class="info-card">
          <h3><i class="fas fa-video"></i> V√≠deo Individual P2P</h3>
          <div style="display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap;">
            <select id="videoIndividualContact" class="input-group" style="flex:1;padding:12px;border:1px solid var(--card-border);border-radius:8px;background:var(--card-bg);color:var(--text-primary);min-width:200px;">
              <option value="">Selecione um contato...</option>
            </select>
            <button class="btn-secondary btn-small" onclick="startIndividualVideoCall()">
              <i class="fas fa-video"></i> Iniciar Chamada
            </button>
          </div>
          
          <div class="video-call-container" id="individualVideoContainer" style="display:none;">
            <div class="video-container">
              <div class="video-placeholder" id="individualVideoPlaceholder">
                <i class="fas fa-video-slash"></i>
                <p>Chamada n√£o iniciada</p>
              </div>
              <video id="individualRemoteVideo" autoplay playsinline style="display:none;"></video>
            </div>
            
            <div class="local-video">
              <video id="individualLocalVideo" autoplay playsinline muted></video>
            </div>
            
            <div class="video-controls">
              <button class="btn-secondary btn-small" id="toggleMicrophoneBtn" onclick="toggleMicrophone()">
                <i class="fas fa-microphone"></i> Microfone
              </button>
              <button class="btn-secondary btn-small" id="toggleCameraBtn" onclick="toggleCamera()">
                <i class="fas fa-camera"></i> C√¢mera
              </button>
              <button class="btn-success btn-small" id="endCallBtn" onclick="endIndividualVideoCall()">
                <i class="fas fa-phone-slash"></i> Encerrar
              </button>
            </div>
          </div>
          
          <div id="individualVideoNotStarted" style="text-align:center;padding:40px;">
            <i class="fas fa-video-slash" style="font-size:48px;color:var(--text-secondary);opacity:0.3;margin-bottom:20px;"></i>
            <p style="color:var(--text-secondary);">
              Selecione um contato e inicie a chamada de v√≠deo
            </p>
          </div>
        </div>
      </div>

      <!-- SUB-ABA: V√çDEO GRUPO -->
      <div class="sub-tab-content hidden" id="videoGroupTab">
        <div class="info-card">
          <h3><i class="fas fa-users"></i> V√≠deo em Grupo P2P</h3>
          <div style="margin-bottom:20px;">
            <label style="display:block;margin-bottom:10px;color:var(--text-secondary);">
              <i class="fas fa-user-friends"></i> Selecione contatos para o grupo de v√≠deo:
            </label>
            <div id="groupVideoContactsList" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));gap:10px;">
              <!-- Contatos para sele√ß√£o ser√£o inseridos aqui -->
            </div>
          </div>
          
          <div style="display:flex;gap:10px;margin-top:20px;flex-wrap:wrap;">
            <input type="text" id="groupVideoName" placeholder="Nome do grupo de v√≠deo" style="flex:1;padding:12px;border:1px solid var(--card-border);border-radius:8px;background:var(--card-bg);color:var(--text-primary);min-width:200px;">
            <button class="btn-secondary btn-small" onclick="createGroupVideoCall()">
              <i class="fas fa-video"></i> Criar Grupo
            </button>
          </div>
          
          <div id="groupVideoContainer" style="display:none;margin-top:20px;">
            <div class="group-video-container" id="groupVideoGrid">
              <!-- V√≠deos dos participantes ser√£o inseridos aqui -->
            </div>
            
            <div class="video-controls" style="margin-top:20px;">
              <button class="btn-secondary btn-small" id="groupToggleMicrophoneBtn" onclick="toggleGroupMicrophone()">
                <i class="fas fa-microphone"></i> Microfone
              </button>
              <button class="btn-secondary btn-small" id="groupToggleCameraBtn" onclick="toggleGroupCamera()">
                <i class="fas fa-camera"></i> C√¢mera
              </button>
              <button class="btn-success btn-small" id="groupEndCallBtn" onclick="endGroupVideoCall()">
                <i class="fas fa-phone-slash"></i> Encerrar Grupo
              </button>
            </div>
          </div>
          
          <div id="groupVideoNotStarted" style="text-align:center;padding:40px;">
            <i class="fas fa-users-slash" style="font-size:48px;color:var(--text-secondary);opacity:0.3;margin-bottom:20px;"></i>
            <p style="color:var(--text-secondary);">
              Selecione contatos e crie um grupo para iniciar a chamada de v√≠deo em grupo
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="notification" id="notification" style="display:none;position:fixed;top:30px;right:30px;padding:20px 25px;background:var(--container-bg);border:1px solid var(--primary-color);border-radius:16px;color:var(--text-primary);z-index:10000;transform:translateX(500px);transition:transform 0.6s cubic-bezier(.25,.46,.45,.94);box-shadow:var(--shadow-luxury);backdrop-filter:blur(20px);max-width:350px;">
    <div id="notificationMessage">‚úÖ Sistema Blockchain Isolado Pronto!</div>
  </div>

  <script>
    // ============================================
    // SISTEMA DE COMUNICA√á√ÉO P2P REAL - SERVERLESS
    // COM INTEGRA√á√ÉO REAL POLYGON WALLET
    // ============================================
    
    let communicationData = {
      linkedWallet: null,
      permissions: {
        chatIndividual: false,
        chatGroup: false,
        videoIndividual: false,
        videoGroup: false,
        microphone: false,
        camera: false
      },
      contacts: [],
      individualChats: {},
      groupChats: {},
      activeConnections: {},
      pendingOffers: {},
      pendingAnswers: {}
    };
    
    // WEBRTC CONFIGURA√á√ïES REAIS
    let localStream = null;
    let peerConnections = {};
    let dataChannels = {};
    let currentVideoCall = null;
    let currentGroupVideoCall = null;
    
    // POLYGON NETWORK CONFIGURATION
    const POLYGON_MAINNET = {
      chainId: '0x89', // 137 em decimal
      chainName: 'Polygon Mainnet',
      nativeCurrency: {
        name: 'MATIC',
        symbol: 'MATIC',
        decimals: 18
      },
      rpcUrls: ['https://polygon-rpc.com/'],
      blockExplorerUrls: ['https://polygonscan.com/']
    };
    
    const POLYGON_MUMBAI = {
      chainId: '0x13881', // 80001 em decimal
      chainName: 'Polygon Mumbai Testnet',
      nativeCurrency: {
        name: 'MATIC',
        symbol: 'MATIC',
        decimals: 18
      },
      rpcUrls: ['https://rpc-mumbai.maticvigil.com/'],
      blockExplorerUrls: ['https://mumbai.polygonscan.com/']
    };
    
    // CARREGAR DADOS DE COMUNICA√á√ÉO
    function loadCommunicationData() {
      const saved = localStorage.getItem('exclusive_wallet_communication');
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          communicationData = {
            ...communicationData,
            ...parsed,
            pendingOffers: parsed.pendingOffers || {},
            pendingAnswers: parsed.pendingAnswers || {}
          };
        } catch (e) {
          console.warn('Erro ao carregar dados de comunica√ß√£o:', e);
        }
      }
      updateAuthorizationUI();
      loadContactsUI();
    }
    
    // SALVAR DADOS DE COMUNICA√á√ÉO
    function saveCommunicationData() {
      localStorage.setItem('exclusive_wallet_communication', JSON.stringify(communicationData));
    }
    
    // MOSTRAR MODAL POLYGON WALLET
    function showPolygonWalletModal() {
      document.getElementById('polygonModal').style.display = 'flex';
    }
    
    // VERIFICAR SE METAMASK EST√Å INSTALADO
    function isMetaMaskInstalled() {
      return typeof window.ethereum !== 'undefined' && window.ethereum.isMetaMask;
    }
    
    // VERIFICAR SE EST√Å NA REDE POLYGON
    async function isPolygonNetwork() {
      if (!window.ethereum) return false;
      
      try {
        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
        return chainId === POLYGON_MAINNET.chainId || chainId === POLYGON_MUMBAI.chainId;
      } catch (error) {
        console.error('Erro ao verificar rede:', error);
        return false;
      }
    }
    
    // TROCAR PARA REDE POLYGON
    async function switchToPolygonNetwork() {
      if (!window.ethereum) {
        showNotification('‚ùå MetaMask n√£o instalado. Instale MetaMask primeiro.', 'error');
        return false;
      }
      
      try {
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: POLYGON_MAINNET.chainId }]
        });
        return true;
      } catch (switchError) {
        // Se a rede n√£o estiver adicionada, adicionar
        if (switchError.code === 4902) {
          try {
            await window.ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [POLYGON_MAINNET]
            });
            return true;
          } catch (addError) {
            console.error('Erro ao adicionar rede Polygon:', addError);
            showNotification('‚ùå Erro ao adicionar rede Polygon ao MetaMask', 'error');
            return false;
          }
        }
        console.error('Erro ao trocar para rede Polygon:', switchError);
        return false;
      }
    }
    
    // CONECTAR COM METAMASK
    async function connectMetaMask() {
      if (!isMetaMaskInstalled()) {
        showNotification('‚ùå MetaMask n√£o encontrado. Instale a extens√£o MetaMask.', 'error');
        return;
      }
      
      try {
        // Tentar trocar para Polygon
        const switched = await switchToPolygonNetwork();
        if (!switched) {
          showNotification('‚ö†Ô∏è Conectando na rede atual...', 'warning');
        }
        
        // Solicitar conex√£o da conta
        const accounts = await window.ethereum.request({
          method: 'eth_requestAccounts'
        });
        
        if (accounts && accounts.length > 0) {
          const address = accounts[0];
          
          // Verificar assinatura para provar propriedade
          const message = `Autorizo comunica√ß√£o P2P - ${Date.now()}`;
          const signature = await window.ethereum.request({
            method: 'personal_sign',
            params: [message, address]
          });
          
          // Verificar rede atual
          const isOnPolygon = await isPolygonNetwork();
          const networkName = isOnPolygon ? 'Polygon' : 'Ethereum';
          
          // Salvar wallet vinculada
          communicationData.linkedWallet = address;
          communicationData.permissions.chatIndividual = true;
          communicationData.permissions.chatGroup = true;
          communicationData.permissions.videoIndividual = true;
          communicationData.permissions.videoGroup = true;
          
          saveCommunicationData();
          updateAuthorizationUI();
          
          document.getElementById('polygonModal').style.display = 'none';
          
          showNotification(`‚úÖ Wallet ${networkName} conectada: ${address.substring(0, 6)}...${address.substring(38)}`, 'success');
          
          // Listener para mudan√ßas de conta
          window.ethereum.on('accountsChanged', handleAccountsChanged);
          window.ethereum.on('chainChanged', handleChainChanged);
          
        } else {
          showNotification('‚ùå Nenhuma conta conectada', 'error');
        }
        
      } catch (error) {
        console.error('Erro ao conectar MetaMask:', error);
        
        if (error.code === 4001) {
          showNotification('‚ùå Conex√£o recusada pelo usu√°rio', 'error');
        } else if (error.code === -32002) {
          showNotification('‚ö†Ô∏è Solicita√ß√£o j√° pendente no MetaMask', 'warning');
        } else {
          showNotification('‚ùå Erro ao conectar com MetaMask: ' + error.message, 'error');
        }
      }
    }
    
    // CONECTAR COM WALLETCONNECT (simula√ß√£o)
    async function connectWalletConnect() {
      showNotification('üîß WalletConnect em desenvolvimento...', 'info');
      // Implementa√ß√£o real requer servidor de relay e configura√ß√£o WalletConnect
      // Para simplicidade, usaremos MetaMask como principal
    }
    
    // HANDLER PARA MUDAN√áA DE CONTAS
    function handleAccountsChanged(accounts) {
      if (accounts.length === 0) {
        showNotification('üîì Wallet desconectada', 'warning');
        communicationData.linkedWallet = null;
        updateAuthorizationUI();
      } else if (accounts[0] !== communicationData.linkedWallet) {
        communicationData.linkedWallet = accounts[0];
        updateAuthorizationUI();
        showNotification(`üîÑ Wallet alterada: ${accounts[0].substring(0, 6)}...`, 'info');
      }
    }
    
    // HANDLER PARA MUDAN√áA DE REDE
    function handleChainChanged(chainId) {
      if (chainId === POLYGON_MAINNET.chainId || chainId === POLYGON_MUMBAI.chainId) {
        showNotification('üåê Conectado √† rede Polygon', 'success');
      } else {
        showNotification('‚ö†Ô∏è Voc√™ n√£o est√° na rede Polygon', 'warning');
      }
    }
    
    // ATUALIZAR UI DE AUTORIZA√á√ÉO
    function updateAuthorizationUI() {
      const authStatus = document.getElementById('authStatus');
      const authStatusText = document.getElementById('authStatusText');
      const linkedAddress = document.getElementById('linkedWalletAddress');
      
      if (communicationData.linkedWallet) {
        linkedAddress.textContent = communicationData.linkedWallet.substring(0, 10) + '...' + communicationData.linkedWallet.substring(communicationData.linkedWallet.length - 8);
        authStatus.className = 'status-indicator verified';
        authStatusText.textContent = 'Status: Autorizado (Polygon)';
      } else {
        linkedAddress.textContent = 'Nenhuma wallet vinculada';
        authStatus.className = 'status-indicator';
        authStatusText.textContent = 'Status: N√£o autorizado';
      }
      
      const permissions = communicationData.permissions;
      document.getElementById('permissionChatIndividual').checked = permissions.chatIndividual;
      document.getElementById('permissionChatGroup').checked = permissions.chatGroup;
      document.getElementById('permissionVideoIndividual').checked = permissions.videoIndividual;
      document.getElementById('permissionVideoGroup').checked = permissions.videoGroup;
      document.getElementById('permissionMicrophone').checked = permissions.microphone;
      document.getElementById('permissionCamera').checked = permissions.camera;
      
      updatePermissionBadges();
    }
    
    // ATUALIZAR BADGES DE PERMISS√ÉO
    function updatePermissionBadges() {
      const permissions = communicationData.permissions;
      const badges = {
        chatIndividualBadge: permissions.chatIndividual,
        chatGroupBadge: permissions.chatGroup,
        videoIndividualBadge: permissions.videoIndividual,
        videoGroupBadge: permissions.videoGroup,
        microphoneBadge: permissions.microphone,
        cameraBadge: permissions.camera
      };
      
      Object.keys(badges).forEach(badgeId => {
        const badge = document.getElementById(badgeId);
        if (badge) {
          if (badges[badgeId]) {
            badge.classList.add('unlocked');
          } else {
            badge.classList.remove('unlocked');
          }
        }
      });
    }
    
    // ALTERAR PERMISS√ÉO
    function togglePermission(permission, enabled) {
      communicationData.permissions[permission] = enabled;
      updatePermissionBadges();
    }
    
    // SALVAR AUTORIZA√á√ïES
    function saveAuthorization() {
      if (!communicationData.linkedWallet) {
        showNotification('‚ùå Conecte uma wallet Polygon primeiro', 'error');
        return;
      }
      
      saveCommunicationData();
      showNotification('‚úÖ Autoriza√ß√µes salvas com sucesso na Polygon Wallet!', 'success');
    }
    
    // CARREGAR CONTATOS NA UI
    function loadContactsUI() {
      const contactsList = document.getElementById('contactsListContainer');
      const chatIndividualSelect = document.getElementById('chatIndividualContact');
      const videoIndividualSelect = document.getElementById('videoIndividualContact');
      
      contactsList.innerHTML = '';
      chatIndividualSelect.innerHTML = '<option value="">Selecione um contato...</option>';
      videoIndividualSelect.innerHTML = '<option value="">Selecione um contato...</option>';
      
      if (communicationData.contacts.length === 0) {
        contactsList.innerHTML = `
          <div class="no-events-message">
            <i class="fas fa-address-book" style="font-size:32px;margin-bottom:10px;opacity:0.5;"></i>
            <p>Nenhum contato adicionado</p>
          </div>
        `;
        return;
      }
      
      communicationData.contacts.forEach((contact, index) => {
        const contactItem = document.createElement('div');
        contactItem.className = 'contact-item';
        contactItem.innerHTML = `
          <div class="contact-info">
            <i class="fab fa-polygon" style="font-size:20px;color:#8247E5;"></i>
            <div>
              <div style="font-weight:600;color:var(--text-primary);">${contact.name || 'Sem nome'}</div>
              <div style="font-size:11px;color:var(--text-secondary);font-family:'Courier New',monospace;">
                ${contact.address.substring(0, 10)}...${contact.address.substring(contact.address.length - 8)}
              </div>
            </div>
          </div>
          <div class="contact-actions">
            <button class="btn-secondary btn-small" onclick="removeContact(${index})" style="font-size:11px;">
              <i class="fas fa-trash"></i> Remover
            </button>
            <button class="btn-secondary btn-small" onclick="showConnectionTools('${contact.address}')" style="font-size:11px;">
              <i class="fas fa-plug"></i> Conectar
            </button>
          </div>
        `;
        contactsList.appendChild(contactItem);
        
        const option = `<option value="${contact.address}">${contact.name || contact.address.substring(0, 10) + '...'}</option>`;
        chatIndividualSelect.innerHTML += option;
        videoIndividualSelect.innerHTML += option;
      });
      
      updateGroupSelectionLists();
    }
    
    // ATUALIZAR LISTAS DE SELE√á√ÉO PARA GRUPOS
    function updateGroupSelectionLists() {
      const groupChatList = document.getElementById('groupChatContactsList');
      const groupVideoList = document.getElementById('groupVideoContactsList');
      
      groupChatList.innerHTML = '';
      groupVideoList.innerHTML = '';
      
      communicationData.contacts.forEach((contact, index) => {
        const contactItem = `
          <label style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:8px;">
            <input type="checkbox" value="${contact.address}" class="group-contact-checkbox">
            <i class="fab fa-polygon" style="color:#8247E5;"></i>
            <span style="font-size:13px;color:var(--text-primary);">${contact.name || contact.address.substring(0, 10) + '...'}</span>
          </label>
        `;
        groupChatList.innerHTML += contactItem;
        groupVideoList.innerHTML += contactItem;
      });
    }
    
    // ADICIONAR CONTATO
    function addContact() {
      const addressInput = document.getElementById('contactWalletAddress');
      const nameInput = document.getElementById('contactName');
      
      const address = addressInput.value.trim();
      const name = nameInput.value.trim();
      
      // Valida√ß√£o b√°sica de endere√ßo Ethereum/Polygon
      if (!address || address.length !== 42 || !address.startsWith('0x')) {
        showNotification('‚ùå Endere√ßo de wallet Polygon inv√°lido', 'error');
        return;
      }
      
      const exists = communicationData.contacts.some(c => c.address.toLowerCase() === address.toLowerCase());
      if (exists) {
        showNotification('‚ùå Este contato j√° foi adicionado', 'error');
        return;
      }
      
      communicationData.contacts.push({
        address: address,
        name: name || '',
        addedAt: new Date().toISOString()
      });
      
      saveCommunicationData();
      loadContactsUI();
      
      addressInput.value = '';
      nameInput.value = '';
      
      showNotification('‚úÖ Contato Polygon adicionado com sucesso!', 'success');
    }
    
    // REMOVER CONTATO
    function removeContact(index) {
      if (confirm('Tem certeza que deseja remover este contato?')) {
        communicationData.contacts.splice(index, 1);
        saveCommunicationData();
        loadContactsUI();
        showNotification('üóëÔ∏è Contato removido', 'info');
      }
    }
    
    // MOSTRAR FERRAMENTAS DE CONEX√ÉO (SINALIZA√á√ÉO MANUAL)
    function showConnectionTools(peerAddress) {
      // Criar overlay para sinaliza√ß√£o manual
      const overlay = document.createElement('div');
      overlay.id = 'signalingOverlay';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        backdrop-filter: blur(10px);
      `;
      
      const contact = communicationData.contacts.find(c => c.address === peerAddress);
      const contactName = contact ? contact.name : peerAddress.substring(0, 10) + '...';
      
      overlay.innerHTML = `
        <div style="
          background: var(--container-bg);
          border: 1px solid var(--primary-color);
          border-radius: 20px;
          padding: 30px;
          max-width: 800px;
          width: 90%;
          max-height: 90vh;
          overflow-y: auto;
          color: var(--text-primary);
        ">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="font-family: 'Cinzel', serif; color: var(--primary-color);">
              <i class="fab fa-polygon" style="color:#8247E5;"></i> Conectar com ${contactName}
            </h3>
            <button onclick="document.getElementById('signalingOverlay').remove()" style="
              background: none;
              border: none;
              color: var(--text-secondary);
              font-size: 20px;
              cursor: pointer;
            ">√ó</button>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <!-- Coluna 1: Criar Oferta -->
            <div>
              <h4 style="color: var(--primary-color); margin-bottom: 10px;">
                <i class="fas fa-share-square"></i> Criar Oferta de Conex√£o
              </h4>
              <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 15px;">
                Gere uma oferta WebRTC e compartilhe com ${contactName}
              </p>
              <button onclick="createOffer('${peerAddress}')" class="btn-primary" style="width: 100%; margin-bottom: 15px;">
                <i class="fas fa-bolt"></i> Gerar Oferta SDP
              </button>
              <div id="offerContainer-${peerAddress}" style="display: none;">
                <textarea id="offerSdp-${peerAddress}" style="
                  width: 100%;
                  height: 120px;
                  background: var(--card-bg);
                  border: 1px solid var(--card-border);
                  color: var(--text-primary);
                  padding: 10px;
                  border-radius: 8px;
                  font-family: 'Courier New', monospace;
                  font-size: 12px;
                  margin-bottom: 10px;
                " readonly></textarea>
                <button onclick="copyToClipboard('offerSdp-${peerAddress}')" class="btn-secondary" style="width: 100%;">
                  <i class="fas fa-copy"></i> Copiar Oferta
                </button>
              </div>
            </div>
            
            <!-- Coluna 2: Inserir Resposta -->
            <div>
              <h4 style="color: var(--primary-color); margin-bottom: 10px;">
                <i class="fas fa-sign-in-alt"></i> Inserir Resposta Recebida
              </h4>
              <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 15px;">
                Cole a resposta SDP recebida de ${contactName}
              </p>
              <textarea id="answerSdpInput-${peerAddress}" placeholder="Cole a resposta SDP aqui..." style="
                width: 100%;
                height: 120px;
                background: var(--card-bg);
                border: 1px solid var(--card-border);
                color: var(--text-primary);
                padding: 10px;
                border-radius: 8px;
                font-family: 'Courier New', monospace;
                font-size: 12px;
                margin-bottom: 10px;
              "></textarea>
              <button onclick="processAnswer('${peerAddress}')" class="btn-success" style="width: 100%;">
                <i class="fas fa-check"></i> Conectar com Resposta
              </button>
            </div>
          </div>
          
          <!-- Ofertas Pendentes -->
          <div id="pendingOffersSection" style="margin-top: 20px; display: none;">
            <h4 style="color: var(--primary-color); margin-bottom: 10px;">
              <i class="fas fa-clock"></i> Ofertas Pendentes
            </h4>
            <div id="pendingOffersList"></div>
          </div>
          
          <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--card-border);">
            <p style="color: var(--text-secondary); font-size: 12px;">
              <i class="fas fa-info-circle"></i> 
              Sistema 100% P2P: As ofertas e respostas SDP cont√™m toda a informa√ß√£o necess√°ria para estabelecer conex√£o direta.
              Compartilhe via qualquer canal seguro (mensagem, email, etc.).
            </p>
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      updatePendingOffersDisplay();
    }
    
    // CRIAR OFERTA SDP
    async function createOffer(peerAddress) {
      try {
        const configuration = {
          iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:global.stun.twilio.com:3478' }
          ]
        };
        
        const peerConnection = new RTCPeerConnection(configuration);
        peerConnections[peerAddress] = peerConnection;
        
        // Criar canal de dados para chat
        const dataChannel = peerConnection.createDataChannel('chat');
        dataChannels[peerAddress] = dataChannel;
        
        dataChannel.onopen = () => {
          console.log('Canal de dados aberto para', peerAddress);
          showNotification('üì° Conex√£o P2P estabelecida!', 'success');
          document.getElementById('signalingOverlay')?.remove();
        };
        
        dataChannel.onmessage = (event) => {
          handleIncomingChatMessage(peerAddress, event.data);
        };
        
        peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            updateOfferDisplay(peerAddress, peerConnection.localDescription);
          }
        };
        
        peerConnection.onconnectionstatechange = () => {
          console.log(`Estado da conex√£o com ${peerAddress}: ${peerConnection.connectionState}`);
        };
        
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        
        communicationData.pendingOffers[peerAddress] = {
          sdp: offer.sdp,
          type: offer.type,
          timestamp: new Date().toISOString()
        };
        saveCommunicationData();
        
        updateOfferDisplay(peerAddress, peerConnection.localDescription);
        updatePendingOffersDisplay();
        
      } catch (error) {
        console.error('Erro ao criar oferta:', error);
        showNotification('‚ùå Erro ao criar oferta: ' + error.message, 'error');
      }
    }
    
    // ATUALIZAR EXIBI√á√ÉO DA OFERTA
    function updateOfferDisplay(peerAddress, description) {
      const offerContainer = document.getElementById(`offerContainer-${peerAddress}`);
      const offerTextarea = document.getElementById(`offerSdp-${peerAddress}`);
      
      if (offerContainer && offerTextarea && description) {
        const offerData = {
          type: description.type,
          sdp: description.sdp,
          from: communicationData.linkedWallet,
          to: peerAddress,
          timestamp: new Date().toISOString()
        };
        
        offerTextarea.value = JSON.stringify(offerData, null, 2);
        offerContainer.style.display = 'block';
      }
    }
    
    // COPIAR PARA √ÅREA DE TRANSFER√äNCIA
    function copyToClipboard(elementId) {
      const element = document.getElementById(elementId);
      if (!element) return;
      
      element.select();
      element.setSelectionRange(0, 99999);
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          showNotification('‚úÖ Copiado para a √°rea de transfer√™ncia!', 'success');
        }
      } catch (err) {
        navigator.clipboard.writeText(element.value)
          .then(() => showNotification('‚úÖ Copiado para a √°rea de transfer√™ncia!', 'success'))
          .catch(() => showNotification('‚ùå Falha ao copiar', 'error'));
      }
    }
    
    // PROCESSAR RESPOSTA SDP
    async function processAnswer(peerAddress) {
      const answerInput = document.getElementById(`answerSdpInput-${peerAddress}`);
      const answerText = answerInput.value.trim();
      
      if (!answerText) {
        showNotification('‚ùå Cole uma resposta SDP v√°lida', 'error');
        return;
      }
      
      try {
        const answerData = JSON.parse(answerText);
        
        if (!answerData.sdp || !answerData.type) {
          throw new Error('Formato SDP inv√°lido');
        }
        
        const configuration = {
          iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:global.stun.twilio.com:3478' }
          ]
        };
        
        const peerConnection = new RTCPeerConnection(configuration);
        peerConnections[peerAddress] = peerConnection;
        
        peerConnection.ondatachannel = (event) => {
          const dataChannel = event.channel;
          dataChannels[peerAddress] = dataChannel;
          
          dataChannel.onopen = () => {
            console.log('Canal de dados aberto para', peerAddress);
            showNotification('üì° Conex√£o P2P estabelecida!', 'success');
            document.getElementById('signalingOverlay')?.remove();
          };
          
          dataChannel.onmessage = (event) => {
            handleIncomingChatMessage(peerAddress, event.data);
          };
        };
        
        peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            // ICE candidates s√£o processados automaticamente
          }
        };
        
        if (localStream) {
          localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
          });
        }
        
        peerConnection.ontrack = (event) => {
          if (event.streams && event.streams[0]) {
            const remoteVideo = document.getElementById('individualRemoteVideo');
            if (remoteVideo) {
              remoteVideo.srcObject = event.streams[0];
              remoteVideo.style.display = 'block';
            }
          }
        };
        
        if (communicationData.pendingOffers[peerAddress]) {
          const offer = communicationData.pendingOffers[peerAddress];
          await peerConnection.setRemoteDescription({
            type: offer.type,
            sdp: offer.sdp
          });
          
          delete communicationData.pendingOffers[peerAddress];
        }
        
        await peerConnection.setRemoteDescription({
          type: answerData.type,
          sdp: answerData.sdp
        });
        
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        
        communicationData.pendingAnswers[peerAddress] = {
          sdp: answer.sdp,
          type: answer.type,
          timestamp: new Date().toISOString()
        };
        
        saveCommunicationData();
        showNotification('‚úÖ Resposta processada! Conex√£o estabelecida.', 'success');
        document.getElementById('signalingOverlay')?.remove();
        
      } catch (error) {
        console.error('Erro ao processar resposta:', error);
        showNotification('‚ùå Erro ao processar resposta: ' + error.message, 'error');
      }
    }
    
    // ATUALIZAR EXIBI√á√ÉO DE OFERTAS PENDENTES
    function updatePendingOffersDisplay() {
      const pendingSection = document.getElementById('pendingOffersSection');
      const pendingList = document.getElementById('pendingOffersList');
      
      if (!pendingSection || !pendingList) return;
      
      const pendingOffers = communicationData.pendingOffers;
      const pendingCount = Object.keys(pendingOffers).length;
      
      if (pendingCount === 0) {
        pendingSection.style.display = 'none';
        return;
      }
      
      pendingSection.style.display = 'block';
      pendingList.innerHTML = '';
      
      Object.entries(pendingOffers).forEach(([peerAddress, offer]) => {
        const contact = communicationData.contacts.find(c => c.address === peerAddress);
        const contactName = contact ? contact.name : peerAddress.substring(0, 10) + '...';
        
        const offerItem = document.createElement('div');
        offerItem.style.cssText = `
          background: var(--card-bg);
          border: 1px solid var(--card-border);
          border-radius: 8px;
          padding: 10px;
          margin-bottom: 10px;
        `;
        
        offerItem.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong style="color: var(--text-primary);">${contactName}</strong>
              <div style="font-size: 11px; color: var(--text-secondary);">
                ${new Date(offer.timestamp).toLocaleString()}
              </div>
            </div>
            <button onclick="copyPendingOffer('${peerAddress}')" class="btn-secondary btn-small">
              <i class="fas fa-copy"></i> Copiar
            </button>
          </div>
        `;
        
        pendingList.appendChild(offerItem);
      });
    }
    
    // COPIAR OFERTA PENDENTE
    function copyPendingOffer(peerAddress) {
      const offer = communicationData.pendingOffers[peerAddress];
      if (!offer) return;
      
      const offerData = {
        type: offer.type,
        sdp: offer.sdp,
        from: communicationData.linkedWallet,
        to: peerAddress,
        timestamp: offer.timestamp
      };
      
      navigator.clipboard.writeText(JSON.stringify(offerData, null, 2))
        .then(() => showNotification('‚úÖ Oferta copiada!', 'success'))
        .catch(() => showNotification('‚ùå Falha ao copiar', 'error'));
    }
    
    // LIDAR COM MENSAGENS DE CHAT RECEBIDAS
    function handleIncomingChatMessage(from, message) {
      try {
        const messageData = JSON.parse(message);
        
        if (!communicationData.individualChats[from]) {
          communicationData.individualChats[from] = {
            messages: [],
            lastActivity: new Date().toISOString()
          };
        }
        
        communicationData.individualChats[from].messages.push({
          text: messageData.text,
          sender: 'them',
          timestamp: new Date().toISOString()
        });
        
        saveCommunicationData();
        
        const currentContact = document.getElementById('chatIndividualContact')?.value;
        if (currentContact === from) {
          loadIndividualChatMessages(from);
        }
        
      } catch (error) {
        console.error('Erro ao processar mensagem recebida:', error);
      }
    }
    
    // CARREGAR MENSAGENS DO CHAT INDIVIDUAL
    function loadIndividualChatMessages(contactAddress) {
      const chatMessages = document.getElementById('individualChatMessages');
      const chatData = communicationData.individualChats[contactAddress];
      
      if (!chatData || chatData.messages.length === 0) {
        chatMessages.innerHTML = `
          <div class="no-events-message">
            <i class="fas fa-comments" style="font-size:32px;margin-bottom:10px;opacity:0.5;"></i>
            <p>Nenhuma mensagem ainda</p>
          </div>
        `;
        return;
      }
      
      chatMessages.innerHTML = '';
      chatData.messages.forEach(msg => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${msg.sender === 'me' ? 'message-sent' : 'message-received'}`;
        messageDiv.innerHTML = `
          <div class="message-sender">${msg.sender === 'me' ? 'Voc√™' : 'Contato'}</div>
          <div>${msg.text}</div>
          <div class="message-time">${new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
        `;
        chatMessages.appendChild(messageDiv);
      });
      
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // INICIAR CHAT INDIVIDUAL
    async function startIndividualChat() {
      const contactSelect = document.getElementById('chatIndividualContact');
      const contactAddress = contactSelect.value;
      
      if (!contactAddress) {
        showNotification('‚ùå Selecione um contato', 'error');
        return;
      }
      
      if (!communicationData.permissions.chatIndividual) {
        showNotification('‚ùå Chat individual n√£o autorizado', 'error');
        return;
      }
      
      document.getElementById('individualChatNotStarted').style.display = 'none';
      const chatContainer = document.getElementById('individualChatContainer');
      chatContainer.style.display = 'flex';
      document.getElementById('individualChatInput').disabled = false;
      document.getElementById('individualChatSendBtn').disabled = false;
      
      if (!communicationData.individualChats[contactAddress]) {
        communicationData.individualChats[contactAddress] = {
          messages: [],
          lastActivity: new Date().toISOString()
        };
        saveCommunicationData();
      }
      
      loadIndividualChatMessages(contactAddress);
      
      if (!peerConnections[contactAddress] || peerConnections[contactAddress].connectionState !== 'connected') {
        showNotification('‚ÑπÔ∏è Conecte-se manualmente usando o bot√£o "Conectar" no gerenciador de contatos', 'info');
      }
    }
    
    // ENVIAR MENSAGEM DE CHAT INDIVIDUAL
    function sendIndividualChatMessage() {
      const input = document.getElementById('individualChatInput');
      const message = input.value.trim();
      const contactSelect = document.getElementById('chatIndividualContact');
      const contactAddress = contactSelect.value;
      
      if (!message || !contactAddress) return;
      
      if (!communicationData.individualChats[contactAddress]) {
        communicationData.individualChats[contactAddress] = {
          messages: [],
          lastActivity: new Date().toISOString()
        };
      }
      
      communicationData.individualChats[contactAddress].messages.push({
        text: message,
        sender: 'me',
        timestamp: new Date().toISOString()
      });
      
      saveCommunicationData();
      
      loadIndividualChatMessages(contactAddress);
      input.value = '';
      
      const dataChannel = dataChannels[contactAddress];
      if (dataChannel && dataChannel.readyState === 'open') {
        dataChannel.send(JSON.stringify({ text: message }));
      } else {
        showNotification('‚ö†Ô∏è Mensagem salva localmente (sem conex√£o P2P ativa)', 'warning');
      }
    }
    
    // CRIAR CHAT EM GRUPO
    function createGroupChat() {
      const groupNameInput = document.getElementById('groupChatName');
      const groupName = groupNameInput.value.trim();
      
      if (!groupName) {
        showNotification('‚ùå Informe um nome para o grupo', 'error');
        return;
      }
      
      if (!communicationData.permissions.chatGroup) {
        showNotification('‚ùå Chat em grupo n√£o autorizado', 'error');
        return;
      }
      
      const selectedContacts = [];
      document.querySelectorAll('.group-contact-checkbox:checked').forEach(cb => {
        selectedContacts.push(cb.value);
      });
      
      if (selectedContacts.length < 2) {
        showNotification('‚ùå Selecione pelo menos 2 contatos para criar um grupo', 'error');
        return;
      }
      
      const groupId = 'group_' + Date.now();
      communicationData.groupChats[groupId] = {
        name: groupName,
        members: selectedContacts,
        messages: [],
        created: new Date().toISOString()
      };
      saveCommunicationData();
      
      document.getElementById('groupChatContainer').style.display = 'flex';
      document.getElementById('groupChatInput').disabled = false;
      document.getElementById('groupChatSendBtn').disabled = false;
      
      groupNameInput.value = '';
      document.querySelectorAll('.group-contact-checkbox').forEach(cb => cb.checked = false);
      
      showNotification(`üë• Grupo "${groupName}" criado. Conecte-se a cada membro individualmente.`, 'success');
    }
    
    // ENVIAR MENSAGEM PARA GRUPO
    function sendGroupChatMessage() {
      const input = document.getElementById('groupChatInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      const groupId = Object.keys(communicationData.groupChats)[0];
      if (groupId) {
        const group = communicationData.groupChats[groupId];
        
        if (!group.messages) group.messages = [];
        group.messages.push({
          text: message,
          sender: 'me',
          timestamp: new Date().toISOString()
        });
        
        let sentCount = 0;
        group.members.forEach(member => {
          const dataChannel = dataChannels[member];
          if (dataChannel && dataChannel.readyState === 'open') {
            dataChannel.send(JSON.stringify({ 
              text: message,
              group: groupId,
              sender: 'group'
            }));
            sentCount++;
          }
        });
        
        if (sentCount === 0) {
          showNotification('üíæ Mensagem salva localmente (sem conex√µes ativas)', 'info');
        }
        
        input.value = '';
      }
    }
    
    // INICIAR CHAMADA DE V√çDEO INDIVIDUAL
    async function startIndividualVideoCall() {
      const contactSelect = document.getElementById('videoIndividualContact');
      const contactAddress = contactSelect.value;
      
      if (!contactAddress) {
        showNotification('‚ùå Selecione um contato', 'error');
        return;
      }
      
      if (!communicationData.permissions.videoIndividual) {
        showNotification('‚ùå V√≠deo individual n√£o autorizado', 'error');
        return;
      }
      
      try {
        const constraints = {
          video: {
            width: { ideal: 1280 },
            height: { ideal: 720 },
            facingMode: 'user'
          },
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          }
        };
        
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        const localVideo = document.getElementById('individualLocalVideo');
        localVideo.srcObject = localStream;
        
        document.getElementById('individualVideoNotStarted').style.display = 'none';
        document.getElementById('individualVideoContainer').style.display = 'block';
        document.getElementById('individualVideoPlaceholder').style.display = 'none';
        
        document.getElementById('toggleMicrophoneBtn').innerHTML = '<i class="fas fa-microphone-slash"></i> Mudo';
        document.getElementById('toggleCameraBtn').innerHTML = '<i class="fas fa-camera-slash"></i> C√¢mera';
        
        currentVideoCall = {
          contact: contactAddress,
          startTime: new Date().toISOString(),
          stream: localStream
        };
        
        if (peerConnections[contactAddress]) {
          localStream.getTracks().forEach(track => {
            peerConnections[contactAddress].addTrack(track, localStream);
          });
        } else {
          showNotification('‚ÑπÔ∏è Estabele√ßa conex√£o manualmente primeiro', 'info');
        }
        
      } catch (error) {
        showNotification('‚ùå Erro ao acessar c√¢mera/microfone: ' + error.message, 'error');
      }
    }
    
    // ALTERNAR MICROFONE
    function toggleMicrophone() {
      if (!localStream) return;
      
      const audioTracks = localStream.getAudioTracks();
      if (audioTracks.length > 0) {
        const enabled = !audioTracks[0].enabled;
        audioTracks[0].enabled = enabled;
        
        const btn = document.getElementById('toggleMicrophoneBtn');
        if (enabled) {
          btn.innerHTML = '<i class="fas fa-microphone-slash"></i> Mudo';
        } else {
          btn.innerHTML = '<i class="fas fa-microphone"></i> Ativar';
        }
      }
    }
    
    // ALTERNAR C√ÇMERA
    function toggleCamera() {
      if (!localStream) return;
      
      const videoTracks = localStream.getVideoTracks();
      if (videoTracks.length > 0) {
        const enabled = !videoTracks[0].enabled;
        videoTracks[0].enabled = enabled;
        
        const btn = document.getElementById('toggleCameraBtn');
        if (enabled) {
          btn.innerHTML = '<i class="fas fa-camera-slash"></i> C√¢mera';
        } else {
          btn.innerHTML = '<i class="fas fa-camera"></i> Ativar';
        }
      }
    }
    
    // ENCERRAR CHAMADA DE V√çDEO INDIVIDUAL
    function endIndividualVideoCall() {
      if (localStream) {
        localStream.getTracks().forEach(track => {
          track.stop();
          track.enabled = false;
        });
        localStream = null;
      }
      
      const localVideo = document.getElementById('individualLocalVideo');
      const remoteVideo = document.getElementById('individualRemoteVideo');
      
      if (localVideo) localVideo.srcObject = null;
      if (remoteVideo) {
        remoteVideo.srcObject = null;
        remoteVideo.style.display = 'none';
      }
      
      document.getElementById('individualVideoContainer').style.display = 'none';
      document.getElementById('individualVideoNotStarted').style.display = 'block';
      
      currentVideoCall = null;
    }
    
    // CRIAR CHAMADA DE V√çDEO EM GRUPO
    async function createGroupVideoCall() {
      const groupNameInput = document.getElementById('groupVideoName');
      const groupName = groupNameInput.value.trim();
      
      if (!groupName) {
        showNotification('‚ùå Informe um nome para o grupo de v√≠deo', 'error');
        return;
      }
      
      if (!communicationData.permissions.videoGroup) {
        showNotification('‚ùå V√≠deo em grupo n√£o autorizado', 'error');
        return;
      }
      
      const selectedContacts = [];
      document.querySelectorAll('#groupVideoContactsList .group-contact-checkbox:checked').forEach(cb => {
        selectedContacts.push(cb.value);
      });
      
      if (selectedContacts.length < 2) {
        showNotification('‚ùå Selecione pelo menos 2 contatos para criar um grupo de v√≠deo', 'error');
        return;
      }
      
      try {
        const constraints = {
          video: true,
          audio: true
        };
        
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        currentGroupVideoCall = {
          name: groupName,
          members: selectedContacts,
          startTime: new Date().toISOString(),
          streams: {}
        };
        
        document.getElementById('groupVideoNotStarted').style.display = 'none';
        document.getElementById('groupVideoContainer').style.display = 'block';
        
        const videoGrid = document.getElementById('groupVideoGrid');
        videoGrid.innerHTML = `
          <div class="group-video-item">
            <video autoplay playsinline muted style="width:100%;height:100%;object-fit:cover;transform: scaleX(-1);"></video>
            <div class="group-video-overlay">Voc√™</div>
          </div>
        `;
        videoGrid.querySelector('video').srcObject = localStream;
        
        selectedContacts.forEach((contact, index) => {
          const contactName = communicationData.contacts.find(c => c.address === contact)?.name || `Membro ${index + 1}`;
          videoGrid.innerHTML += `
            <div class="group-video-item" id="video-${contact}">
              <div style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;background:#111;">
                <i class="fas fa-user" style="font-size:32px;color:#444;"></i>
              </div>
              <div class="group-video-overlay">${contactName}</div>
            </div>
          `;
        });
        
        document.getElementById('groupToggleMicrophoneBtn').innerHTML = '<i class="fas fa-microphone-slash"></i> Mudo';
        document.getElementById('groupToggleCameraBtn').innerHTML = '<i class="fas fa-camera-slash"></i> C√¢mera';
        
        groupNameInput.value = '';
        document.querySelectorAll('#groupVideoContactsList .group-contact-checkbox').forEach(cb => cb.checked = false);
        
        showNotification(`üë• Grupo "${groupName}" criado. Conecte-se a cada membro individualmente.`, 'success');
        
      } catch (error) {
        showNotification('‚ùå Erro ao acessar c√¢mera/microfone: ' + error.message, 'error');
      }
    }
    
    // ALTERNAR MICROFONE DO GRUPO
    function toggleGroupMicrophone() {
      if (!localStream) return;
      
      const audioTracks = localStream.getAudioTracks();
      if (audioTracks.length > 0) {
        const enabled = !audioTracks[0].enabled;
        audioTracks[0].enabled = enabled;
        
        const btn = document.getElementById('groupToggleMicrophoneBtn');
        if (enabled) {
          btn.innerHTML = '<i class="fas fa-microphone-slash"></i> Mudo';
        } else {
          btn.innerHTML = '<i class="fas fa-microphone"></i> Ativar';
        }
      }
    }
    
    // ALTERNAR C√ÇMERA DO GRUPO
    function toggleGroupCamera() {
      if (!localStream) return;
      
      const videoTracks = localStream.getVideoTracks();
      if (videoTracks.length > 0) {
        const enabled = !videoTracks[0].enabled;
        videoTracks[0].enabled = enabled;
        
        const btn = document.getElementById('groupToggleCameraBtn');
        if (enabled) {
          btn.innerHTML = '<i class="fas fa-camera-slash"></i> C√¢mera';
        } else {
          btn.innerHTML = '<i class="fas fa-camera"></i> Ativar';
        }
      }
    }
    
    // ENCERRAR CHAMADA DE V√çDEO EM GRUPO
    function endGroupVideoCall() {
      if (localStream) {
        localStream.getTracks().forEach(track => {
          track.stop();
          track.enabled = false;
        });
        localStream = null;
      }
      
      document.getElementById('groupVideoGrid').innerHTML = '';
      document.getElementById('groupVideoContainer').style.display = 'none';
      document.getElementById('groupVideoNotStarted').style.display = 'block';
      
      currentGroupVideoCall = null;
    }
    
    // GERENCIAMENTO DE SUB-ABAS
    function initializeSubTabs() {
      document.querySelectorAll('.sub-tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const subtabId = this.dataset.subtab;
          
          document.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.sub-tab-content').forEach(c => c.classList.add('hidden'));
          
          this.classList.add('active');
          document.getElementById(subtabId).classList.remove('hidden');
          
          if (subtabId === 'authorizationTab') {
            updateAuthorizationUI();
          }
        });
      });
    }
    
    // NOTIFICA√á√ÉO
    function showNotification(message, type = 'info') {
      const notification = document.getElementById('notification');
      const messageElement = document.getElementById('notificationMessage');
      messageElement.textContent = message;
      notification.style.display = 'block';
      notification.style.transform = 'translateX(0)';
      setTimeout(() => {
        notification.style.transform = 'translateX(500px)';
      }, 4000);
    }
    
    // LIMPAR DADOS DE CONEX√ÉO
    function clearConnectionData() {
      Object.values(peerConnections).forEach(pc => pc.close());
      Object.values(dataChannels).forEach(dc => dc.close());
      peerConnections = {};
      dataChannels = {};
      
      communicationData.pendingOffers = {};
      communicationData.pendingAnswers = {};
      saveCommunicationData();
      
      showNotification('üßπ Conex√µes P2P limpas', 'info');
    }
    
    // INICIALIZA√á√ÉO
    window.addEventListener('DOMContentLoaded', () => {
      loadCommunicationData();
      initializeSubTabs();
      
      const header = document.querySelector('header');
      if (header) {
        const clearBtn = document.createElement('button');
        clearBtn.className = 'btn-secondary btn-small';
        clearBtn.innerHTML = '<i class="fas fa-broom"></i> Limpar Conex√µes';
        clearBtn.onclick = clearConnectionData;
        clearBtn.style.marginLeft = 'auto';
        header.appendChild(clearBtn);
      }
      
      showNotification('‚úÖ Sistema P2P Serverless Pronto! Conecte sua Polygon Wallet para come√ßar.', 'success');
    });
  </script>
</body>
</html>
