<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sistema de Comunicação - Exclusive Wallet</title>
  
  <!-- MESMOS RECURSOS DO INDEX -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Cinzel:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="css/styles.css">
  
  <!-- WEBRTC REAL -->
  <script src="https://cdn.jsdelivr.net/npm/webrtc-adapter@latest/dist/adapter.min.js"></script>
</head>
<body class="theme-luxury">
  <!-- CONTEÚDO IDÊNTICO À ABA COMUNICAÇÃO ORIGINAL -->
  <div id="communication-content" style="padding: 20px; max-width: 1400px; margin: 0 auto;">
    <div class="wallet-header">
      <h2><i class="fas fa-comments"></i> Sistema de Comunicação Premium</h2>
      <p>Comunicação criptografada ponto-a-ponto via Polygon Network</p>
    </div>

    <!-- Sub-navegação -->
    <div class="sub-tab-navigation">
      <button class="sub-tab-btn active" data-subtab="authTab">
        <i class="fas fa-key"></i> Autorização
      </button>
      <button class="sub-tab-btn" data-subtab="contactsTab">
        <i class="fas fa-users"></i> Contatos
      </button>
      <button class="sub-tab-btn" data-subtab="chatTab">
        <i class="fas fa-comment"></i> Chat Privado
      </button>
      <button class="sub-tab-btn" data-subtab="videoTab">
        <i class="fas fa-video"></i> Vídeo Chamada
      </button>
      <button class="sub-tab-btn" data-subtab="groupTab">
        <i class="fas fa-comments"></i> Grupos
      </button>
      <button class="sub-tab-btn" data-subtab="groupVideoTab">
        <i class="fas fa-video"></i> Vídeo em Grupo
      </button>
    </div>

    <!-- Sub-abas -->
    <div class="communication-main-content">
      <!-- Autorização -->
      <div class="sub-tab-content active" id="authTab">
        <div class="authorization-box">
          <h3 class="address-registration-title">
            <i class="fas fa-user-shield"></i> Autorização de Acesso
          </h3>
          
          <p class="address-instruction">
            Para acessar o sistema de comunicação, você precisa autorizar seu endereço Polygon.
          </p>
          
          <div class="input-group">
            <label for="authWalletAddress">Seu Endereço Polygon para Autorização</label>
            <input type="text" id="authWalletAddress" placeholder="0x..." style="font-family: 'Courier New', monospace;">
          </div>
          
          <div class="verification-status">
            <div class="status-indicator" id="authStatusIndicator" style="background: var(--text-secondary);"></div>
            <span id="authStatusText" style="color: var(--text-secondary); font-size: 13px;">Não autorizado</span>
          </div>
          
          <button class="btn btn-primary" onclick="CommunicationSystem.authorizeChatAccess()">
            <i class="fas fa-check"></i> Autorizar Acesso
          </button>
        </div>
      </div>

      <!-- Contatos -->
      <div class="sub-tab-content hidden" id="contactsTab">
        <div class="communication-main-container">
          <h3 class="address-registration-title">
            <i class="fas fa-address-book"></i> Gerenciamento de Contatos
          </h3>
          
          <div class="contacts-list-container" id="contactsList">
            <!-- Contatos carregados via JS -->
          </div>
          
          <div class="add-contact-form">
            <h4><i class="fas fa-user-plus"></i> Adicionar Novo Contato</h4>
            <div class="input-group">
              <label for="newContactName">Nome do Contato</label>
              <input type="text" id="newContactName" placeholder="Ex: João Silva">
            </div>
            <div class="input-group">
              <label for="newContactAddress">Endereço Polygon do Contato</label>
              <input type="text" id="newContactAddress" placeholder="0x..." style="font-family: 'Courier New', monospace;">
            </div>
            <button class="btn btn-primary" onclick="CommunicationSystem.addNewContact()">
              <i class="fas fa-plus"></i> Adicionar Contato
            </button>
          </div>
        </div>
      </div>

      <!-- Chat Privado -->
      <div class="sub-tab-content hidden" id="chatTab">
        <div class="communication-main-container">
          <h3 class="address-registration-title">
            <i class="fas fa-comment-dots"></i> Chat Privado Criptografado
          </h3>
          
          <div class="input-group">
            <label for="selectChatContact">Selecionar Contato para Conversar</label>
            <select id="selectChatContact">
              <option value="">Selecione um contato</option>
            </select>
          </div>
          
          <div class="chat-container">
            <div class="chat-messages" id="privateChatMessages">
              <div class="message message-received">
                <div class="message-sender">Sistema</div>
                <div>Selecione um contato para iniciar uma conversa privada.</div>
                <div class="message-time">Agora</div>
              </div>
            </div>
            
            <div class="chat-input-area">
              <input type="text" class="chat-input" id="privateChatInput" 
                     placeholder="Digite sua mensagem..." onkeypress="CommunicationSystem.handleChatKeyPress(event)">
              <button class="btn btn-primary btn-small" onclick="CommunicationSystem.sendPrivateMessage()">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Vídeo Chamada -->
      <div class="sub-tab-content hidden" id="videoTab">
        <div class="communication-main-container">
          <h3 class="address-registration-title">
            <i class="fas fa-video"></i> Chamada de Vídeo Segura
          </h3>
          
          <div class="input-group">
            <label for="selectVideoContact">Selecionar Contato para Vídeo Chamada</label>
            <select id="selectVideoContact">
              <option value="">Selecione um contato</option>
            </select>
          </div>
          
          <div class="video-container" id="videoCallContainer">
            <div class="video-placeholder">
              <i class="fas fa-video"></i>
              <div>Chamada de vídeo não iniciada</div>
            </div>
          </div>
          
          <div class="video-controls">
            <button class="btn btn-primary btn-small" id="startVideoBtn" onclick="CommunicationSystem.startVideoCall()">
              <i class="fas fa-video"></i> Iniciar Vídeo
            </button>
            <button class="btn btn-secondary btn-small" id="endVideoBtn" onclick="CommunicationSystem.endVideoCall()" disabled>
              <i class="fas fa-phone-slash"></i> Encerrar
            </button>
          </div>
        </div>
      </div>

      <!-- Grupos -->
      <div class="sub-tab-content hidden" id="groupTab">
        <div class="communication-main-container">
          <h3 class="address-registration-title">
            <i class="fas fa-users"></i> Grupos de Comunicação
          </h3>
          
          <div class="add-contact-form">
            <h4><i class="fas fa-plus-circle"></i> Criar Novo Grupo</h4>
            <div class="input-group">
              <label for="groupName">Nome do Grupo</label>
              <input type="text" id="groupName" placeholder="Ex: Time de Desenvolvimento">
            </div>
            <button class="btn btn-primary" onclick="CommunicationSystem.createGroup()">
              <i class="fas fa-plus"></i> Criar Grupo
            </button>
          </div>
          
          <div class="dev-agenda-grid" id="availableGroups">
            <!-- Grupos carregados via JS -->
          </div>
          
          <div class="chat-container" style="height: 300px; margin-top: 20px;">
            <div class="chat-messages" id="groupChatMessages">
              <div class="message message-received">
                <div class="message-sender">Sistema</div>
                <div>Entre em um grupo para começar a conversar.</div>
                <div class="message-time">Agora</div>
              </div>
            </div>
            
            <div class="chat-input-area">
              <input type="text" class="chat-input" id="groupChatInput" 
                     placeholder="Digite sua mensagem para o grupo..." onkeypress="CommunicationSystem.handleGroupChatKeyPress(event)">
              <button class="btn btn-primary btn-small" onclick="CommunicationSystem.sendGroupMessage()">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Vídeo em Grupo -->
      <div class="sub-tab-content hidden" id="groupVideoTab">
        <div class="communication-main-container">
          <h3 class="address-registration-title">
            <i class="fas fa-video"></i> Reuniões de Vídeo em Grupo
          </h3>
          
          <div style="display: flex; gap: 30px; flex-wrap: wrap;">
            <div style="flex: 0 0 250px;">
              <div style="background: var(--gradient-card); border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                <h4><i class="fas fa-plus-circle"></i> Criar Reunião</h4>
                <div class="input-group">
                  <label for="groupVideoName">Nome da Reunião</label>
                  <input type="text" id="groupVideoName" placeholder="Ex: Reunião de Planejamento">
                </div>
                <button class="btn btn-primary btn-small" onclick="CommunicationSystem.createGroupVideo()">
                  <i class="fas fa-video"></i> Criar Reunião
                </button>
              </div>
              
              <div style="background: var(--gradient-card); border-radius: 12px; padding: 20px;">
                <h4><i class="fas fa-sign-in-alt"></i> Entrar na Reunião</h4>
                <div class="input-group">
                  <label for="groupVideoCode">Código da Reunião</label>
                  <input type="text" id="groupVideoCode" placeholder="Digite o código">
                </div>
                <button class="btn btn-primary btn-small" onclick="CommunicationSystem.joinGroupVideo()">
                  <i class="fas fa-users"></i> Entrar na Reunião
                </button>
              </div>
            </div>
            
            <div style="flex: 1; min-width: 300px;">
              <div class="video-container" id="groupVideoContainer" style="height: 400px;">
                <div class="video-placeholder">
                  <i class="fas fa-users" style="font-size: 48px;"></i>
                  <div>Nenhuma reunião ativa</div>
                </div>
              </div>
              
              <div class="contacts-list-container" id="participantsList" style="max-height: 150px; margin-top: 20px;">
                <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                  <i class="fas fa-user-friends"></i>
                  <div>Nenhum participante na reunião</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- WEBRTC REAL E COMUNICAÇÃO -->
  <script src="js/communication.js"></script>
  
  <!-- SISTEMA DE COMUNICAÇÃO COM INDEX PRINCIPAL -->
  <script>
    class CommunicationSystem {
      static init() {
        this.setupEventListeners();
        this.loadContacts();
        this.setupParentCommunication();
        this.notifyHeight();
      }
      
      static setupParentCommunication() {
        // Ouvir mensagens do index.html
        window.addEventListener('message', (event) => {
          if (event.data.type === 'SYNC_THEME') {
            document.body.className = `theme-${event.data.theme}`;
          }
          
          if (event.data.type === 'SYNC_SUB_TAB') {
            this.switchSubTab(event.data.tabId);
          }
          
          if (event.data.type === 'ACTIVATE_SUB_TAB') {
            this.switchSubTab(event.data.tabId);
            this.notifySubTabChanged(event.data.tabId);
          }
        });
        
        // Notificar altura ao pai
        this.heightObserver = new ResizeObserver(() => {
          this.notifyHeight();
        });
        this.heightObserver.observe(document.body);
      }
      
      static notifyHeight() {
        const height = document.documentElement.scrollHeight;
        window.parent.postMessage({
          type: 'HEIGHT_UPDATE',
          height: height
        }, '*');
      }
      
      static notifySubTabChanged(tabId) {
        window.parent.postMessage({
          type: 'SUB_TAB_CHANGED',
          tabId: tabId
        }, '*');
      }
      
      static switchSubTab(tabId) {
        document.querySelectorAll('.sub-tab-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.getAttribute('data-subtab') === tabId) {
            btn.classList.add('active');
          }
        });
        
        document.querySelectorAll('.sub-tab-content').forEach(content => {
          content.classList.add('hidden');
          if (content.id === tabId) {
            content.classList.remove('hidden');
          }
        });
        
        this.notifyHeight();
      }
      
      static setupEventListeners() {
        // Sub-tabs locais
        document.querySelectorAll('.sub-tab-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const tabId = btn.getAttribute('data-subtab');
            this.switchSubTab(tabId);
            this.notifySubTabChanged(tabId);
          });
        });
        
        // Sistema WebRTC será inicializado aqui
        WebRTCManager.init();
      }
      
      // Métodos de comunicação (serão implementados em communication.js)
      static authorizeChatAccess() {
        window.parent.postMessage({
          type: 'NOTIFICATION',
          message: '✅ Acesso ao chat autorizado!',
          type: 'success'
        }, '*');
      }
      
      static addNewContact() {
        // Implementado em communication.js
      }
      
      static sendPrivateMessage() {
        // Implementado em communication.js
      }
      
      static startVideoCall() {
        // Implementado em communication.js
      }
      
      static createGroup() {
        // Implementado em communication.js
      }
      
      static createGroupVideo() {
        // Implementado em communication.js
      }
      
      static loadContacts() {
        // Carregar do localStorage
      }
    }
    
    // Inicializar quando carregar
    document.addEventListener('DOMContentLoaded', () => {
      CommunicationSystem.init();
    });
  </script>
</body>
</html>
